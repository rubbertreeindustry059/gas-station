<!doctype html>
<html lang="th" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="./sdk/data_sdk.js"></script>
  <script src="./sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap"
    rel="stylesheet">
  <style>
    * {
      font-family: 'Sarabun', sans-serif;
    }

    .tab-active {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
    }

    .card-gradient {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }

    .header-gradient {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #3b82f6 100%);
    }

    .fuel-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .diesel {
      background: #fef3c7;
      color: #92400e;
    }

    .gasohol95 {
      background: #dcfce7;
      color: #166534;
    }

    .gasohol91 {
      background: #dbeafe;
      color: #1e40af;
    }

    .e20 {
      background: #fce7f3;
      color: #9d174d;
    }

    .e85 {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .premium {
      background: #fed7aa;
      color: #c2410c;
    }

    .fuel-custom {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #15803d 0%, #166534 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #c2410c 0%, #92400e 100%);
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .stat-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .nozzle-card {
      background: #f8fafc;
      border-left: 4px solid #3b82f6;
    }

    .stock-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fef08a 100%);
      border-left: 4px solid #f59e0b;
    }
  </style>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
</head>

<body class="h-full bg-slate-100">
  <div id="app" class="h-full flex flex-col overflow-auto">
    <header class="header-gradient text-white p-4 shadow-lg sticky top-0 z-40">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="text-2xl">‚õΩ</span>
          </div>
          <div>
            <h1 id="appTitle" class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h1>
            <p id="appSubtitle" class="text-blue-100 text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Ä¢ ‡∏™‡∏ï‡πä‡∏≠‡∏Å ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-blue-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
          <p id="currentDate" class="font-semibold"></p>
        </div>
      </div>
    </header>
    <nav class="bg-white shadow-sm border-b sticky top-16 z-30">
      <div class="max-w-7xl mx-auto flex overflow-x-auto"><button onclick="switchTab('record')" id="tab-record"
          class="tab-active flex-1 min-w-max px-4 py-3 text-sm font-medium transition-all rounded-t-lg"> üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button> <button onclick="switchTab('stock')" id="tab-stock"
          class="flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all rounded-t-lg">
          üõ¢Ô∏è ‡∏™‡∏ï‡πä‡∏≠‡∏Å </button> <button onclick="switchTab('report')" id="tab-report"
          class="flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all rounded-t-lg">
          üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button> <button onclick="switchTab('settings')" id="tab-settings"
          class="flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all rounded-t-lg">
          ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ </button>
      </div>
    </nav>
    <main class="flex-1 p-4 max-w-7xl mx-auto w-full pb-24"><!-- Record Tab -->
      <section id="section-record" class="space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="todaySales" class="text-lg font-bold text-blue-600">‡∏ø0</p>
          </div>
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏•‡∏¥‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</p>
            <p id="todayLiters" class="text-lg font-bold text-green-600">0 ‡∏•‡∏¥‡∏ï‡∏£</p>
          </div>
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="todayProfit" class="text-lg font-bold text-emerald-600">‡∏ø0</p>
          </div>
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            <p id="todayTransactions" class="text-lg font-bold text-purple-600">0</p>
          </div>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">üìù</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏∞
          </h2>
          <form id="recordForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-3 pb-4 border-b">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date"
                  id="recordDate"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏Å‡∏∞</label> <select id="recordShift"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <!-- Dynamic Shift Options -->
                </select>
              </div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-800 mb-3">üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</h3>
              <div id="nozzleMetersContainer" class="space-y-3">
                <p class="text-gray-400 text-xs text-center py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</p>
              </div>
            </div><button type="submit" id="recordSubmitBtn"
              class="w-full btn-primary text-white py-3 rounded-lg font-medium transition-all"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </form>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">üìä</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
          </h2>
          <div id="todayFuelSummary" class="space-y-3">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          </div>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
              class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">‚úÖ</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
          <div id="todayRecords" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          </div>
        </div>
      </section><!-- Stock Tab -->
      <section id="section-stock" class="hidden space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <p id="totalTanks" class="text-lg font-bold text-blue-600">0</p>
          </div>
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°</p>
            <p id="totalStock" class="text-lg font-bold text-green-600">0 ‡∏•‡∏¥‡∏ï‡∏£</p>
          </div>
          <div class="stat-card card-gradient rounded-xl p-4 shadow-sm border">
            <p class="text-xs text-gray-500 mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</p>
            <p id="stockValue" class="text-lg font-bold text-amber-600">‡∏ø0</p>
          </div>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">ÔøΩ</span> ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
            (Batch Entry)</h2>

          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3 pb-4 border-b">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label> <input type="date"
                  id="stockDate"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ</label> <input type="text"
                  id="batchNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 123"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>

            <!-- Item Entry Form -->
            <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
              <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</h3>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label> <select
                    id="itemTank" class="w-full px-3 py-2 border rounded-lg text-sm bg-white">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏±‡∏á...</option>
                  </select>
                </div>
                <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏•‡∏¥‡∏ï‡∏£)</label> <input
                    type="number" id="itemLiters" step="0.01" placeholder="0.00"
                    class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ø)</label>
                  <input type="number" id="itemTotalPrice" step="0.01" placeholder="0.00"
                    class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div class="flex items-end">
                  <button type="button" onclick="addStockItem()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition-all">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </button>
                </div>
              </div>
            </div>

            <!-- Temp Item List -->
            <div id="tempStockItems" class="space-y-2">
              <!-- Dynamically populated items -->
            </div>

            <!-- Shared Costs Section -->
            <div id="sharedCostsSection" class="pt-4 border-t hidden">
              <h3 class="text-sm font-medium text-gray-800 mb-3 flex items-center gap-2">üöö ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                (‡∏õ‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏¥‡∏ï‡∏£)</h3>
              <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏ß‡∏° (‡∏ø)</label> <input
                    type="number" id="batchTransportCost" step="0.01" placeholder="0.00" value="0"
                    class="w-full px-3 py-2 border rounded-lg text-sm" oninput="recalculateBatch()">
                </div>
                <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ø)</label> <input
                    type="number" id="batchOtherCost" step="0.01" placeholder="0.00" value="0"
                    class="w-full px-3 py-2 border rounded-lg text-sm" oninput="recalculateBatch()">
                </div>
                <div class="text-right flex flex-col justify-end">
                  <p class="text-[10px] text-gray-500">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏¥‡∏•</p>
                  <p id="totalBatchValueDisplay" class="text-lg font-bold text-blue-700">‡∏ø0.00</p>
                </div>
              </div>

              <div id="prorationSummary" class="mt-4 bg-blue-50 p-3 rounded-lg text-xs text-blue-800 space-y-1">
                <!-- Proration details will appear here -->
              </div>

              <button type="button" onclick="saveBatchStock()"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-bold transition-all mt-4 shadow-md">
                ÔøΩ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏•‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ
              </button>
            </div>
          </div>
        </div>

        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
              class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">üì¶</span> ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
          <div id="stockSummary" class="space-y-3">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p>
          </div>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
              class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">üìú</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å</h2>
          <div id="stockHistory" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
          </div>
        </div>
      </section><!-- Report Tab -->
      <section id="section-report" class="hidden space-y-4">
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">üîç</span> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
          <div class="space-y-3">
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label> <select
                id="reportType"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                <option value="range">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>
                <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              </select>
            </div>
            <div id="filterDaily"><label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label> <input
                type="date" id="reportDate"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏∞</label> <select id="reportShift"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏Å‡∏∞</option>
                <option value="morning">‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</option>
                <option value="evening">üåô ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢</option>
              </select>
            </div>
            <div id="filterRange" class="hidden grid grid-cols-2 gap-3">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date"
                  id="reportStartDate"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date"
                  id="reportEndDate"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
            <div id="filterMonthly" class="hidden"><label
                class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label> <input type="month"
                id="reportMonth"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div><button onclick="generateReport()"
              class="w-full btn-primary text-white py-3 rounded-lg font-medium transition-all"> üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button>
          </div>
        </div>
        <div id="reportSummary" class="hidden card-gradient rounded-xl p-4 shadow-sm border">
          <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <h2 class="font-semibold text-gray-800 flex items-center gap-2"><span
                class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">üìà</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
            <button onclick="exportPDF()"
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
              üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF </button>
          </div>
          <div id="reportPeriod" class="text-sm text-gray-500 mb-4"></div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="bg-blue-50 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
              <p id="reportTotalSales" class="text-lg font-bold text-blue-600">‡∏ø0</p>
            </div>
            <div class="bg-green-50 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-500">‡∏•‡∏¥‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</p>
              <p id="reportTotalLiters" class="text-lg font-bold text-green-600">0</p>
            </div>
            <div class="bg-amber-50 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
              <p id="reportTotalCost" class="text-lg font-bold text-amber-600">‡∏ø0</p>
            </div>
            <div class="bg-emerald-50 rounded-lg p-3 text-center">
              <p id="reportTotalProfit" class="text-lg font-bold text-emerald-600">‡∏ø0</p>
            </div>
          </div>
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-2 text-sm">üìä ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î</h3>
            <div id="fuelTypeSummary" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
          </div>
          <h3 class="font-medium text-gray-700 mb-2 text-sm">üîå ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</h3>
          <div id="reportNozzleDetails" class="space-y-2"></div>
        </div>
      </section><!-- Settings Tab -->
      <section id="section-settings" class="hidden space-y-4">
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <form id="settingsForm" class="space-y-4">
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label> <input type="text"
                id="settingStationName" placeholder="‡πÄ‡∏ä‡πà‡∏ô RTI Wood Oil"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏∞ 1 (‡πÄ‡∏ä‡πâ‡∏≤)</label> <input
                  type="text" id="settingShift1Name" placeholder="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 06:00-18:00)</label> <input
                  type="text" id="settingShift1Time" placeholder="06:00-18:00"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏∞ 2 (‡∏ö‡πà‡∏≤‡∏¢/‡∏Ñ‡πà‡∏≥)</label> <input
                  type="text" id="settingShift2Name" placeholder="‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 18:00-06:00)</label> <input
                  type="text" id="settingShift2Time" placeholder="18:00-06:00"
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div><button type="submit"
              class="w-full btn-primary text-white py-2 rounded-lg font-medium transition-all"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </form>
        </div>

        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">üí∞</span> ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢/‡∏•‡∏¥‡∏ï‡∏£
            (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h2>
          <form id="priceForm" class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡∏î‡∏µ‡πÄ‡∏ã‡∏•</label> <input type="number"
                step="0.01" id="price-diesel" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 95</label> <input
                type="number" step="0.01" id="price-gasohol95" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 91</label> <input
                type="number" step="0.01" id="price-gasohol91" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">E20</label> <input type="number"
                step="0.01" id="price-e20" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">E85</label> <input type="number"
                step="0.01" id="price-e85" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-[10px] font-medium text-gray-500 mb-1">‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 95</label> <input type="number"
                step="0.01" id="price-premium" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
            <button type="submit"
              class="col-span-full btn-success text-white py-2 rounded-lg font-medium transition-all mt-2"> üíæ
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ </button>
          </form>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">üõ¢Ô∏è</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà
          </h2>
          <form id="tankForm" class="space-y-4">
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏±‡∏á</label> <input type="text"
                id="tankName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏±‡∏á‡∏î‡∏µ‡πÄ‡∏ã‡∏•, ‡∏ñ‡∏±‡∏á‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 95"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label> <select
                id="tankFuelType"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="diesel">üõ¢Ô∏è ‡∏î‡∏µ‡πÄ‡∏ã‡∏•</option>
                <option value="gasohol95">üü¢ ‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 95</option>
                <option value="gasohol91">üîµ ‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 91</option>
                <option value="e20">üü° E20</option>
                <option value="e85">üíú E85</option>
                <option value="premium">üü† ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 95</option>
              </select>
            </div><button type="submit" id="tankSubmitBtn"
              class="w-full btn-warning text-white py-3 rounded-lg font-medium transition-all"> üõ¢Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
            </button>
          </form>
        </div>

        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">‚õΩ</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h2>
          <form id="fuelTypeForm" class="space-y-4 mb-6">
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label> <input type="text"
                  id="newFuelName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 91" class="w-full px-3 py-2 border rounded-lg text-sm">
              </div>
              <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label> <input
                  type="text" id="newFuelId" placeholder="‡πÄ‡∏ä‡πà‡∏ô b91" class="w-full px-3 py-2 border rounded-lg text-sm">
              </div>
            </div>
            <button type="submit"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition-all">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà </button>
          </form>
          <div id="fuelTypeList" class="space-y-2 pt-4 border-t">
            <!-- Dynamic list of fuel types -->
          </div>
        </div>

        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span
              class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">üîå</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
          <form id="nozzleForm" class="space-y-4">
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</label> <input type="text"
                id="nozzleName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà 1"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div><label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label> <select
                id="nozzleFuelType"
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="diesel">üõ¢Ô∏è ‡∏î‡∏µ‡πÄ‡∏ã‡∏•</option>
                <option value="gasohol95">üü¢ ‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 95</option>
                <option value="gasohol91">üîµ ‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 91</option>
                <option value="e20">üü° E20</option>
                <option value="e85">üíú E85</option>
                <option value="premium">üü† ‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 95</option>
              </select>
            </div><button type="submit" id="nozzleSubmitBtn"
              class="w-full btn-success text-white py-3 rounded-lg font-medium transition-all"> üîå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢
            </button>
          </form>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
              class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">üõ¢Ô∏è</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h2>
          <div id="tankList" class="space-y-2">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p>
          </div>
        </div>
        <div class="card-gradient rounded-xl p-4 shadow-sm border">
          <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
              class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">üíæ</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</h2>
          <div id="nozzleList" class="space-y-2">
            <p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</p>
          </div>
        </div>
      </section>
    </main><!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
        <div class="text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-3xl">‚ö†Ô∏è</span>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p id="deleteModalText" class="text-gray-600 text-sm mb-6"></p>
          <div class="flex gap-3"><button onclick="closeDeleteModal()"
              class="flex-1 px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 transition-all"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
            <button onclick="confirmDelete()" class="flex-1 btn-danger text-white px-4 py-2 rounded-lg transition-all">
              ‡∏•‡∏ö </button>
          </div>
        </div>
      </div>
    </div><!-- Edit Record Modal -->
    <div id="editRecordModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
        <p id="editRecordNozzle" class="text-sm text-gray-600 mb-4 font-medium text-center"></p>
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
            <input type="number" step="0.01" id="editMeterStart"
              class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" readonly>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
            <input type="number" step="0.01" id="editMeterEnd"
              class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="closeEditModal()"
              class="flex-1 px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 transition-all"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
            <button onclick="confirmEditRecord()"
              class="flex-1 btn-primary text-white px-4 py-2 rounded-lg transition-all"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç </button>
          </div>
        </div>
      </div>
    </div><!-- Toast -->
    <div id="toast"
      class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all">
      <span id="toastMessage"></span>
    </div><!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
      <div class="bg-white rounded-xl p-6 flex items-center gap-3">
        <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span
          class="text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
      </div>
    </div>
  </div>
  <script>
    window.allData = [];
    let nozzles = [];
    let records = [];
    let tanks = [];
    let stockRecords = [];
    let settings = {
      stationName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
      shift1Name: '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤',
      shift1Time: '06:00-18:00',
      shift2Name: '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢',
      shift2Time: '18:00-06:00',
      fuelTypeNames: {
        diesel: '‡∏î‡∏µ‡πÄ‡∏ã‡∏•',
        gasohol95: '‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 95',
        gasohol91: '‡πÅ‡∏Å‡πä‡∏™‡πÇ‡∏ã‡∏Æ‡∏≠‡∏•‡πå 91',
        e20: 'E20',
        e85: 'E85',
        premium: '‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 95'
      },
      fuelPrices: {
        diesel: 33.00,
        gasohol95: 35.00,
        gasohol91: 34.00,
        e20: 32.00,
        e85: 30.00,
        premium: 40.00
      }
    };
    let fuelTypeNames = settings.fuelTypeNames; // Keep reference for backward compatibility
    let currentTab = 'record';
    let deleteTarget = null;
    let reportData = null;
    let batchStockItems = []; // Temporary items during entry

    // Fuel type names moved to settings for dynamic management
    const fuelTypeIcons = {
      diesel: 'üõ¢Ô∏è',
      gasohol95: 'üü¢',
      gasohol91: 'üîµ',
      e20: 'üü°',
      e85: 'üíú',
      premium: 'üü†'
    };

    const defaultCosts = {
      diesel: 32.00,
      gasohol95: 36.00,
      gasohol91: 33.00,
      e20: 32.00,
      e85: 30.00,
      premium: 38.00
    };

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        window.allData = data; // Ensure SDK can see recent data
        nozzles = data.filter(d => d.type === 'nozzle');
        records = data.filter(d => d.type === 'record');
        tanks = data.filter(d => d.type === 'tank');
        stockRecords = data.filter(d => d.type === 'stock_record');

        const settingsData = data.find(d => d.type === 'settings');
        if (settingsData) {
          settings = { ...settings, ...settingsData };
          // Ensure fuelTypeNames is updated before UI
          fuelTypeNames = settings.fuelTypeNames;
          updateSystemUI();
        } else {
          // Default initialization
          fuelTypeNames = settings.fuelTypeNames;
          updateSystemUI();
        }

        updateNozzleMetersForm();
        updateRecordFormStatus();
        updateNozzleList();
        updateTankList();
        updateStockTankSelect();
        updateItemTankSelect();
        updateTodayStats();
        updateTodayFuelSummary();
        updateTodayRecords();
        updateStockSummary();
        updateStockHistory();
      }
    };

    async function init() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDate').value = today;
      document.getElementById('reportStartDate').value = today;
      document.getElementById('reportEndDate').value = today;
      document.getElementById('reportMonth').value = today.substring(0, 7);
      document.getElementById('stockDate').value = today;
      document.getElementById('currentDate').textContent = formatThaiDate(today);

      loadLastDateShift();

      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Canva Sheet', 'error');
      }

      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
      document.getElementById('nozzleForm').addEventListener('submit', handleNozzleSubmit);
      document.getElementById('tankForm').addEventListener('submit', handleTankSubmit);
      document.getElementById('settingsForm').addEventListener('submit', handleSettingsSubmit);
      document.getElementById('priceForm').addEventListener('submit', handlePriceSubmit);
      document.getElementById('fuelTypeForm').addEventListener('submit', handleFuelTypeSubmit);
      document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
      document.getElementById('recordDate').addEventListener('change', handleDateShiftChange);
      document.getElementById('recordShift').addEventListener('change', handleDateShiftChange);
    }

    function updateSystemUI() {
      document.getElementById('appTitle').textContent = settings.stationName;
      document.title = settings.stationName;

      const shiftSelect = document.getElementById('recordShift');
      const reportShiftSelect = document.getElementById('reportShift');
      const currentValue = shiftSelect.value;

      const shiftOptions = `
        <option value="morning">‚òÄÔ∏è ${settings.shift1Name} (${settings.shift1Time})</option>
        <option value="evening">üåô ${settings.shift2Name} (${settings.shift2Time})</option>
      `;

      shiftSelect.innerHTML = shiftOptions;
      reportShiftSelect.innerHTML = `<option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏Å‡∏∞</option>` + shiftOptions;

      if (currentValue) shiftSelect.value = currentValue;

      // Update settings form if in settings tab
      document.getElementById('settingStationName').value = settings.stationName;
      document.getElementById('settingShift1Name').value = settings.shift1Name;
      document.getElementById('settingShift1Time').value = settings.shift1Time;
      document.getElementById('settingShift2Name').value = settings.shift2Name;
      document.getElementById('settingShift2Time').value = settings.shift2Time;

      // Update fuel type reference global
      fuelTypeNames = settings.fuelTypeNames;

      // Update price form
      const priceForm = document.getElementById('priceForm');
      const submitBtn = priceForm.querySelector('button[type="submit"]');

      const priceInputsHtml = Object.entries(settings.fuelTypeNames).map(([id, name]) => `
        <div>
          <label class="block text-[10px] font-medium text-gray-500 mb-1">${name}</label>
          <input type="number" step="0.01" id="price-${id}" value="${settings.fuelPrices[id] || 0}" class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
      `).join('');

      priceForm.innerHTML = priceInputsHtml;
      priceForm.appendChild(submitBtn);

      // Update Fuel Type Management List
      const fuelTypeList = document.getElementById('fuelTypeList');
      fuelTypeList.innerHTML = Object.entries(settings.fuelTypeNames).map(([id, name]) => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
          <div class="flex items-center gap-2">
            <span class="fuel-badge ${['diesel', 'gasohol95', 'gasohol91', 'e20', 'e85', 'premium'].includes(id) ? id : 'fuel-custom'}">${name}</span>
            <span class="text-[10px] text-gray-400">ID: ${id}</span>
          </div>
          <button onclick="deleteFuelType('${id}')" class="text-red-500 hover:text-red-700 text-sm">‡∏•‡∏ö</button>
        </div>
      `).join('');

      // Update all Fuel Type Selects
      const fuelOptions = Object.entries(settings.fuelTypeNames).map(([id, name]) => `
        <option value="${id}">${name}</option>
      `).join('');

      document.getElementById('tankFuelType').innerHTML = fuelOptions;
      document.getElementById('nozzleFuelType').innerHTML = fuelOptions;
    }

    async function handleFuelTypeSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('newFuelName').value.trim();
      const id = document.getElementById('newFuelId').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');

      if (!name || !id) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const newSettings = {
        ...settings,
        type: 'settings',
        fuelTypeNames: { ...settings.fuelTypeNames, [id]: name },
        fuelPrices: { ...settings.fuelPrices, [id]: settings.fuelPrices[id] || 0 },
        timestamp: new Date().toISOString()
      };

      await saveSettings(newSettings);
      document.getElementById('fuelTypeForm').reset();
    }

    async function deleteFuelType(id) {
      if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô "${settings.fuelTypeNames[id]}"?\n*‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•`)) {
        const newFuelTypeNames = { ...settings.fuelTypeNames };
        const newFuelPrices = { ...settings.fuelPrices };
        delete newFuelTypeNames[id];
        delete newFuelPrices[id];

        const newSettings = {
          ...settings,
          type: 'settings',
          fuelTypeNames: newFuelTypeNames,
          fuelPrices: newFuelPrices,
          timestamp: new Date().toISOString()
        };

        await saveSettings(newSettings);
      }
    }

    async function saveSettings(newSettings) {
      showLoading(true);
      try {
        const existingSettings = (window.allData || []).find(d => d.type === 'settings');
        let result;
        if (existingSettings) {
          newSettings.__backendId = existingSettings.__backendId;
          result = await window.dataSdk.update(newSettings);
        } else {
          result = await window.dataSdk.create(newSettings);
        }

        if (result && result.isOk) {
          settings = { ...settings, ...newSettings };
          updateSystemUI();
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
        }
      } catch (err) {
        console.error('Save Settings Error:', err);
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ' + err.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function handlePriceSubmit(e) {
      e.preventDefault();
      const newPrices = {};
      Object.keys(settings.fuelTypeNames).forEach(id => {
        const input = document.getElementById(`price-${id}`);
        if (input) newPrices[id] = parseFloat(input.value) || 0;
      });

      const newSettings = {
        ...settings,
        type: 'settings',
        fuelPrices: newPrices,
        timestamp: new Date().toISOString()
      };

      await saveSettings(newSettings);
    }

    async function handleSettingsSubmit(e) {
      e.preventDefault();
      const newSettings = {
        ...settings,
        type: 'settings',
        stationName: document.getElementById('settingStationName').value || '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
        shift1Name: document.getElementById('settingShift1Name').value || '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤',
        shift1Time: document.getElementById('settingShift1Time').value || '06:00-18:00',
        shift2Name: document.getElementById('settingShift2Name').value || '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢',
        shift2Time: document.getElementById('settingShift2Time').value || '18:00-06:00',
        timestamp: new Date().toISOString()
      };

      await saveSettings(newSettings);
    }

    function handleDateShiftChange() {
      const date = document.getElementById('recordDate').value;
      const shift = document.getElementById('recordShift').value;

      if (date && shift) {
        saveLastDateShift(date, shift);
        updateMetersFromLastRecord();
        updateRecordFormStatus();
      }
    }

    function saveLastDateShift(date, shift) {
      localStorage.setItem('lastRecordDate', date);
      localStorage.setItem('lastRecordShift', shift);
    }

    function loadLastDateShift() {
      const today = new Date().toISOString().split('T')[0];
      const lastDate = localStorage.getItem('lastRecordDate');
      const lastShift = localStorage.getItem('lastRecordShift');

      if (lastDate) {
        document.getElementById('recordDate').value = lastDate;
      } else {
        document.getElementById('recordDate').value = today;
      }

      if (lastShift) {
        document.getElementById('recordShift').value = lastShift;
      }
    }

    function updateMetersFromLastRecord() {
      const date = document.getElementById('recordDate').value;
      const shift = document.getElementById('recordShift').value;

      if (!date || !shift) return;

      nozzles.forEach(nozzle => {
        // Find the absolute latest record for this nozzle BEFORE or AT the current selection
        // For simplicity, we just find the latest one in the system
        const lastRecord = records
          .filter(r => r.nozzle_name === nozzle.nozzle_name)
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

        const startInput = document.querySelector(`.meter-input[data-nozzle="${nozzle.__backendId}"][data-type="start"]`);
        const endInput = document.querySelector(`.meter-input[data-nozzle="${nozzle.__backendId}"][data-type="end"]`);
        const statusBadge = document.querySelector(`.nozzle-card[data-nozzle-name="${nozzle.nozzle_name}"] .latest-meter-badge`);

        if (lastRecord) {
          if (startInput) startInput.value = lastRecord.meter_end.toFixed(2);
          if (statusBadge) statusBadge.textContent = `‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastRecord.meter_end.toFixed(2)}`;
        } else {
          if (startInput) startInput.value = '0.00';
          if (statusBadge) statusBadge.textContent = '';
        }

        if (endInput) {
          endInput.value = '';
          calculateMeterDifference({ target: endInput });
        }
      });
    }

    function updateNozzleMetersForm() {
      const container = document.getElementById('nozzleMetersContainer');

      if (nozzles.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-xs text-center py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</p>';
        return;
      }

      container.innerHTML = nozzles.map(nozzle => {
        const currentPrice = settings.fuelPrices[nozzle.fuel_type] || 0;

        return `
          <div class="nozzle-card rounded-lg p-4" data-nozzle-name="${nozzle.nozzle_name}">
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="flex items-center gap-2">
                  <p class="font-medium text-gray-800">${nozzle.nozzle_name}</p>
                  <span class="recorded-status hidden text-[10px] bg-green-500 text-white px-2 py-0.5 rounded-full">‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="fuel-badge ${nozzle.fuel_type}">${fuelTypeNames[nozzle.fuel_type]}</span>
                  <span class="text-xs text-blue-600 font-bold">‡∏ø${currentPrice.toFixed(2)}</span>
                </div>
              </div>
              <span class="latest-meter-badge text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded"></span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-gray-600 font-medium mb-1 block">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="number" step="0.01" value="0.00" data-nozzle="${nozzle.__backendId}" data-type="start" class="meter-input w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
              </div>
              <div>
                <label class="text-xs text-gray-600 font-medium mb-1 block">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="number" step="0.01" value="" data-nozzle="${nozzle.__backendId}" data-type="end" class="meter-input w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
              </div>
              <div>
                <label class="text-xs text-gray-600 font-medium mb-1 block">‡∏•‡∏¥‡∏ï‡∏£</label>
                <div class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-blue-600 text-center">
                  <span class="meter-calc" data-nozzle="${nozzle.__backendId}">0.00</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.querySelectorAll('.meter-input').forEach(input => {
        input.addEventListener('input', calculateMeterDifference);
      });

      updateMetersFromLastRecord();
    }

    function calculateMeterDifference(e) {
      const nozzleId = e.target.dataset.nozzle;
      const startInput = document.querySelector(`.meter-input[data-nozzle="${nozzleId}"][data-type="start"]`);
      const endInput = document.querySelector(`.meter-input[data-nozzle="${nozzleId}"][data-type="end"]`);
      const calcDisplay = document.querySelector(`.meter-calc[data-nozzle="${nozzleId}"]`);

      const start = parseFloat(startInput.value) || 0;
      const end = parseFloat(endInput.value) || 0;
      const diff = Math.max(0, end - start);

      calcDisplay.textContent = diff.toFixed(2);
    }

    function calculateTotalStockCost() {
      const liters = parseFloat(document.getElementById('stockLiters').value) || 0;
      const costPerLiter = parseFloat(document.getElementById('stockCostPerLiter').value) || 0;
      const transport = parseFloat(document.getElementById('stockTransportCost').value) || 0;
      const storage = parseFloat(document.getElementById('stockStorageCost').value) || 0;
      const other = parseFloat(document.getElementById('stockOtherCost').value) || 0;

      const total = (liters * costPerLiter) + transport + storage + other;
      document.getElementById('totalStockCostDisplay').textContent = '‡∏ø' + total.toLocaleString('th-TH', { minimumFractionDigits: 2 });
    }

    function switchTab(tab) {
      currentTab = tab;
      ['record', 'stock', 'report', 'settings'].forEach(t => {
        document.getElementById(`section-${t}`).classList.toggle('hidden', t !== tab);
        document.getElementById(`tab-${t}`).classList.toggle('tab-active', t === tab);
        document.getElementById(`tab-${t}`).classList.toggle('text-gray-600', t !== tab);
      });
    }

    async function handleTankSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('tankName').value.trim();
      const fuelType = document.getElementById('tankFuelType').value;

      if (!name) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      showLoading(true);
      const result = await window.dataSdk.create({
        type: 'tank',
        tank_name: name,
        fuel_type: fuelType,
        timestamp: new Date().toISOString()
      });
      showLoading(false);

      if (result.isOk) {
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
        document.getElementById('tankForm').reset();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    async function handleNozzleSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('nozzleName').value.trim();
      const fuelType = document.getElementById('nozzleFuelType').value;
      // const price = parseFloat(document.getElementById('nozzlePrice').value) || 0; // Removed price input

      if (!name) { // Removed price validation
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      const cost = defaultCosts[fuelType] || 30.00;

      showLoading(true);
      const result = await window.dataSdk.create({
        type: 'nozzle',
        nozzle_name: name,
        fuel_type: fuelType,
        cost_per_liter: cost,
        timestamp: new Date().toISOString()
      });
      showLoading(false);

      if (result.isOk) {
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
        document.getElementById('nozzleForm').reset();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    async function handleStockSubmit(e) {
      e.preventDefault();
      const date = document.getElementById('stockDate').value;
      const tankId = document.getElementById('stockTank').value;
      const liters = parseFloat(document.getElementById('stockLiters').value) || 0;
      const costPerLiter = parseFloat(document.getElementById('stockCostPerLiter').value) || 0;
      const transportCost = parseFloat(document.getElementById('stockTransportCost').value) || 0;
      const storageCost = parseFloat(document.getElementById('stockStorageCost').value) || 0;
      const otherCost = parseFloat(document.getElementById('stockOtherCost').value) || 0;
      const costNote = document.getElementById('stockCostNote').value.trim();

      if (!date || !tankId || liters <= 0 || costPerLiter <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      const tank = tanks.find(t => t.__backendId === tankId);
      if (!tank) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', 'error');
        return;
      }

      const totalCost = (liters * costPerLiter) + transportCost + storageCost + otherCost;

      showLoading(true);
      const result = await window.dataSdk.create({
        type: 'stock_record',
        date: date,
        tank_name: tank.tank_name,
        fuel_type: tank.fuel_type,
        liters_added: liters,
        cost_per_liter_stock: costPerLiter,
        total_cost_stock: totalCost,
        transport_cost: transportCost,
        storage_cost: storageCost,
        other_cost: otherCost,
        cost_note: costNote,
        timestamp: new Date().toISOString()
      });
      showLoading(false);

      if (result.isOk) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
        document.getElementById('stockForm').reset();
        document.getElementById('stockDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('stockTransportCost').value = '0';
        document.getElementById('stockStorageCost').value = '0';
        document.getElementById('stockOtherCost').value = '0';
        calculateTotalStockCost();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    async function handleRecordSubmit(e) {
      e.preventDefault();
      const date = document.getElementById('recordDate').value;
      const shift = document.getElementById('recordShift').value;

      if (!date) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
        return;
      }

      let hasValidData = false;
      const recordsToAdd = [];
      const skippedNozzles = [];

      document.querySelectorAll('.meter-input[data-type="end"]').forEach(input => {
        const nozzleId = input.dataset.nozzle;
        const nozzle = nozzles.find(n => n.__backendId === nozzleId);
        const startInput = document.querySelector(`.meter-input[data-nozzle="${nozzleId}"][data-type="start"]`);

        const meterStart = parseFloat(startInput.value) || 0;
        const meterEnd = parseFloat(input.value) || 0;

        if (input.value !== '' && meterEnd > 0) {
          if (meterEnd < meterStart) {
            alert(`‚ö†Ô∏è ‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢ ${nozzle.nozzle_name}: ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (${meterEnd}) ‡∏´‡πâ‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (${meterStart})!`);
            hasValidData = false;
            recordsToAdd.length = 0; // Clear all to prevent partial save
            return;
          }

          // Check for existing record
          const isDuplicate = records.some(r =>
            r.date === date &&
            r.shift === shift &&
            r.nozzle_name === nozzle.nozzle_name
          );

          if (isDuplicate) {
            skippedNozzles.push(nozzle.nozzle_name);
            return;
          }

          const currentPrice = settings.fuelPrices[nozzle.fuel_type] || 0;
          const liters = meterEnd - meterStart;
          const revenue = liters * currentPrice;
          const cost = liters * (nozzle.cost_per_liter || defaultCosts[nozzle.fuel_type]);
          const profit = revenue - cost;

          recordsToAdd.push({
            type: 'record',
            date: date,
            shift: shift,
            nozzle_name: nozzle.nozzle_name,
            fuel_type: nozzle.fuel_type,
            meter_start: meterStart,
            meter_end: meterEnd,
            liters_sold: liters,
            price_per_liter: currentPrice,
            revenue: revenue,
            cost_per_liter: nozzle.cost_per_liter || defaultCosts[nozzle.fuel_type],
            cost: cost,
            profit: profit,
            timestamp: new Date().toISOString()
          });
          hasValidData = true;
        }
      });

      if (skippedNozzles.length > 0) {
        if (!confirm(`‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢ [${skippedNozzles.join(', ')}] ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏∞‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß \n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          return;
        }
      }

      if (!hasValidData && skippedNozzles.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', 'error');
        return;
      }

      if (recordsToAdd.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'warning');
        return;
      }

      if (allData.length + recordsToAdd.length > 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      showLoading(true);
      try {
        const result = await window.dataSdk.createBatch(recordsToAdd);
        if (result.isOk) {
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
          document.querySelectorAll('.meter-input[data-type="end"]').forEach(input => {
            input.value = '';
            calculateMeterDifference({ target: input });
          });
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ' + err.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Add function to re-render form status when date/shift changes
    function updateRecordFormStatus() {
      const date = document.getElementById('recordDate').value;
      const shift = document.getElementById('recordShift').value;

      nozzles.forEach(nozzle => {
        const isRecorded = records.some(r => r.date === date && r.shift === shift && r.nozzle_name === nozzle.nozzle_name);
        const card = document.querySelector(`.nozzle-card[data-nozzle-name="${nozzle.nozzle_name}"]`);
        if (card) {
          card.style.opacity = isRecorded ? '0.6' : '1';
          const statusBadge = card.querySelector('.recorded-status');
          if (statusBadge) statusBadge.classList.toggle('hidden', !isRecorded);
        }
      });
    }

    function updateStockTankSelect() {
      // Empty or legacy if needed
    }

    function updateItemTankSelect() {
      const select = document.getElementById('itemTank');
      if (tanks.length === 0) {
        select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏±‡∏á...</option>';
        return;
      }
      select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏±‡∏á...</option>' + tanks.map(t =>
        `<option value="${t.__backendId}">${t.tank_name} (${fuelTypeNames[t.fuel_type]})</option>`
      ).join('');
    }

    function addStockItem() {
      const tankId = document.getElementById('itemTank').value;
      const liters = parseFloat(document.getElementById('itemLiters').value);
      const totalPrice = parseFloat(document.getElementById('itemTotalPrice').value);

      if (!tankId || isNaN(liters) || liters <= 0 || isNaN(totalPrice) || totalPrice < 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const tank = tanks.find(t => t.__backendId === tankId);
      batchStockItems.push({
        id: Date.now(),
        tankId,
        tankName: tank.tank_name,
        fuelType: tank.fuel_type,
        liters,
        basePrice: totalPrice
      });

      renderBatchItems();
      document.getElementById('itemLiters').value = '';
      document.getElementById('itemTotalPrice').value = '';
      recalculateBatch();
    }

    function removeStockItem(id) {
      batchStockItems = batchStockItems.filter(item => item.id !== id);
      renderBatchItems();
      recalculateBatch();
    }

    function renderBatchItems() {
      const container = document.getElementById('tempStockItems');
      const section = document.getElementById('sharedCostsSection');

      if (batchStockItems.length === 0) {
        container.innerHTML = '';
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      container.innerHTML = batchStockItems.map(item => `
        <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
          <div>
            <p class="font-bold text-gray-800 text-sm">${item.tankName}</p>
            <p class="text-[10px] text-gray-500">${item.liters.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£ | ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ‡∏ø${item.basePrice.toLocaleString()}</p>
          </div>
          <button onclick="removeStockItem(${item.id})" class="text-red-500 hover:text-red-700"> ‡∏•‡∏ö </button>
        </div>
      `).join('');
    }

    function recalculateBatch() {
      if (batchStockItems.length === 0) return;

      const totalLiters = batchStockItems.reduce((sum, item) => sum + item.liters, 0);
      const transport = parseFloat(document.getElementById('batchTransportCost').value) || 0;
      const otherCosts = parseFloat(document.getElementById('batchOtherCost').value) || 0;
      const totalShared = transport + otherCosts;

      let totalBaseAmount = 0;
      const prorationLines = batchStockItems.map(item => {
        const shareRatio = item.liters / totalLiters;
        const allocatedShared = shareRatio * totalShared;
        const finalCost = item.basePrice + allocatedShared;
        const finalCostPerLiter = finalCost / item.liters;
        totalBaseAmount += item.basePrice;

        return `‚Ä¢ <b>${item.tankName}:</b> ‡∏õ‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏ù‡∏á ‡∏ø${allocatedShared.toFixed(2)} (${(shareRatio * 100).toFixed(1)}%) -> ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <b>‡∏ø${finalCostPerLiter.toFixed(2)}/‡∏•‡∏¥‡∏ï‡∏£</b>`;
      });

      document.getElementById('totalBatchValueDisplay').textContent = '‡∏ø' + (totalBaseAmount + totalShared).toLocaleString('th-TH', { minimumFractionDigits: 2 });
      document.getElementById('prorationSummary').innerHTML = `
        <p class="font-bold border-b border-blue-200 pb-1 mb-1">üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏£‡∏ß‡∏° ${totalLiters.toFixed(0)} ‡∏•‡∏¥‡∏ï‡∏£):</p>
        ${prorationLines.join('<br>')}
      `;
    }

    async function saveBatchStock() {
      const date = document.getElementById('stockDate').value;
      if (!date) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', 'error');
        return;
      }

      const totalLiters = batchStockItems.reduce((sum, item) => sum + item.liters, 0);
      const transport = parseFloat(document.getElementById('batchTransportCost').value) || 0;
      const otherCosts = parseFloat(document.getElementById('batchOtherCost').value) || 0;
      const totalShared = transport + otherCosts;
      const note = document.getElementById('batchNote').value;

      const recordsToSave = [];
      for (const item of batchStockItems) {
        const shareRatio = item.liters / totalLiters;
        const allocatedShared = shareRatio * totalShared;
        const totalItemCost = item.basePrice + allocatedShared;
        const costPerLiter = totalItemCost / item.liters;

        recordsToSave.push({
          type: 'stock_record',
          date: date,
          tank_name: item.tankName,
          fuel_type: item.fuelType,
          liters_added: item.liters,
          cost_per_liter_stock: costPerLiter,
          total_cost_stock: totalItemCost,
          transport_cost: shareRatio * transport,
          other_cost: shareRatio * otherCosts,
          cost_note: note + (note ? ' | ' : '') + `‡∏õ‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•‡∏£‡∏ß‡∏° (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${item.tankName})`,
          timestamp: new Date().toISOString()
        });
      }

      showLoading(true);
      try {
        const result = await window.dataSdk.createBatch(recordsToSave);
        if (result.isOk) {
          batchStockItems = [];
          renderBatchItems();
          document.getElementById('batchTransportCost').value = '0';
          document.getElementById('batchOtherCost').value = '0';
          document.getElementById('batchNote').value = '';
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
          switchTab('stock');
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ' + err.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function updateTankList() {
      const container = document.getElementById('tankList');
      if (tanks.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p>';
        return;
      }

      container.innerHTML = tanks.map(t => `
        <div class="p-3 bg-gray-50 rounded-lg flex items-center justify-between">
          <div class="flex items-center gap-3 flex-1">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <span>üõ¢Ô∏è</span>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">${t.tank_name}</p>
              <span class="fuel-badge ${t.fuel_type}">${fuelTypeNames[t.fuel_type]}</span>
            </div>
          </div>
          <button onclick="deleteTank('${t.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all">
            üóëÔ∏è
          </button>
        </div>
      `).join('');
    }

    function updateStockSummary() {
      const container = document.getElementById('stockSummary');

      if (tanks.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p>';
        document.getElementById('totalTanks').textContent = '0';
        document.getElementById('totalStock').textContent = '0 ‡∏•‡∏¥‡∏ï‡∏£';
        document.getElementById('stockValue').textContent = '‡∏ø0';
        return;
      }

      const stockData = {};
      tanks.forEach(tank => {
        stockData[tank.__backendId] = {
          name: tank.tank_name,
          fuelType: tank.fuel_type,
          totalLiters: 0,
          totalValue: 0
        };
      });

      stockRecords.forEach(r => {
        const tankEntry = Object.values(stockData).find(s => s.name === r.tank_name);
        if (tankEntry) {
          tankEntry.totalLiters += r.liters_added;
          tankEntry.totalValue += r.total_cost_stock;
        }
      });

      records.forEach(r => {
        const tankEntry = Object.values(stockData).find(s => s.fuelType === r.fuel_type);
        if (tankEntry) {
          tankEntry.totalLiters -= r.liters_sold;
        }
      });

      let totalAllLiters = 0;
      let totalAllValue = 0;

      const summaryHtml = Object.entries(stockData).map(([id, data]) => {
        totalAllLiters += data.totalLiters;
        totalAllValue += data.totalValue;
        const safeStock = Math.max(0, data.totalLiters);
        return `
          <div class="stock-card rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <p class="font-medium text-gray-800">${data.name}</p>
              <span class="fuel-badge ${data.fuelType}">${fuelTypeNames[data.fuelType]}</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs text-gray-600">‡∏•‡∏¥‡∏ï‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                <p class="text-lg font-bold text-blue-600">${safeStock.toFixed(2)}</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</p>
                <p class="text-lg font-bold text-amber-600">‡∏ø${Math.max(0, data.totalValue).toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = summaryHtml;

      document.getElementById('totalTanks').textContent = tanks.length;
      document.getElementById('totalStock').textContent = Math.max(0, totalAllLiters).toFixed(0) + ' ‡∏•‡∏¥‡∏ï‡∏£';
      document.getElementById('stockValue').textContent = '‡∏ø' + Math.max(0, totalAllValue).toLocaleString('th-TH', { minimumFractionDigits: 0 });
    }

    function updateStockHistory() {
      const container = document.getElementById('stockHistory');

      if (stockRecords.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        return;
      }

      const sortedRecords = [...stockRecords].sort((a, b) =>
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      container.innerHTML = sortedRecords.map(r => {
        const baseCost = r.liters_added * r.cost_per_liter_stock;
        const transportCost = r.transport_cost || 0;
        const storageCost = r.storage_cost || 0;
        const otherCost = r.other_cost || 0;
        const totalCost = r.total_cost_stock;

        return `
          <div class="p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <p class="font-medium text-gray-800">${r.tank_name}</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="fuel-badge ${r.fuel_type}">${fuelTypeNames[r.fuel_type]}</span>
                  <span class="text-xs text-gray-500">${r.liters_added.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">${formatThaiDate(r.date)}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-amber-600">‡∏ø${totalCost.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
                <p class="text-xs text-gray-500">‡∏ø${r.cost_per_liter_stock.toFixed(2)}/‡∏•‡∏¥‡∏ï‡∏£</p>
              </div>
            </div>
            ${(transportCost > 0 || storageCost > 0 || otherCost > 0) ? `
              <div class="grid grid-cols-4 gap-1 text-xs mb-2 pb-2 border-t pt-2">
                ${transportCost > 0 ? `<div class="bg-blue-50 p-1 rounded text-center"><p class="text-gray-500">‡∏Ç‡∏ô‡∏™‡πà‡∏á</p><p class="font-bold text-blue-600">‡∏ø${transportCost.toFixed(0)}</p></div>` : ''}
                ${storageCost > 0 ? `<div class="bg-green-50 p-1 rounded text-center"><p class="text-gray-500">‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</p><p class="font-bold text-green-600">‡∏ø${storageCost.toFixed(0)}</p></div>` : ''}
                ${otherCost > 0 ? `<div class="bg-orange-50 p-1 rounded text-center"><p class="text-gray-500">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p><p class="font-bold text-orange-600">‡∏ø${otherCost.toFixed(0)}</p></div>` : ''}
                <div class="bg-red-50 p-1 rounded text-center"><p class="text-gray-500">‡πÄ‡∏ö‡∏™</p><p class="font-bold text-red-600">‡∏ø${baseCost.toFixed(0)}</p></div>
              </div>
              ${r.cost_note ? `<p class="text-xs text-gray-500 italic mb-2">üìù ${r.cost_note}</p>` : ''}
            ` : ''}
            <button onclick="deleteStockRecord('${r.__backendId}')" class="text-xs bg-red-100 text-red-600 hover:bg-red-200 px-2 py-1 rounded transition-all w-full">
              ‚ùå ‡∏•‡∏ö
            </button>
          </div>
        `;
      }).join('');
    }

    function updateTodayStats() {
      const today = new Date().toISOString().split('T')[0];
      const todayRecordsList = records.filter(r => r.date === today);

      let totalSales = 0;
      let totalLiters = 0;
      let totalCost = 0;

      todayRecordsList.forEach(r => {
        totalSales += r.revenue || 0;
        totalLiters += r.liters_sold || 0;
        totalCost += r.cost || 0;
      });

      document.getElementById('todaySales').textContent = '‡∏ø' + totalSales.toLocaleString('th-TH', { minimumFractionDigits: 0 });
      document.getElementById('todayLiters').textContent = totalLiters.toFixed(0) + ' ‡∏•‡∏¥‡∏ï‡∏£';
      document.getElementById('todayProfit').textContent = '‡∏ø' + totalSales.toLocaleString('th-TH', { minimumFractionDigits: 0 });
      document.getElementById('todayTransactions').textContent = todayRecordsList.length;
    }

    function updateTodayFuelSummary() {
      const today = new Date().toISOString().split('T')[0];
      const todayRecordsList = records.filter(r => r.date === today);

      if (todayRecordsList.length === 0) {
        document.getElementById('todayFuelSummary').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
        return;
      }

      const fuelSummary = {};
      todayRecordsList.forEach(r => {
        const fuelType = r.fuel_type;
        if (!fuelSummary[fuelType]) {
          fuelSummary[fuelType] = {
            totalLiters: 0,
            totalRevenue: 0
          };
        }
        fuelSummary[fuelType].totalLiters += r.liters_sold;
        fuelSummary[fuelType].totalRevenue += r.revenue;
      });

      const summaryHtml = Object.entries(fuelSummary).map(([fuelType, data]) => `
        <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fuel-badge ${fuelType}">${fuelTypeNames[fuelType]}</span>
              <span class="text-sm font-bold text-gray-800">${data.totalLiters.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</span>
            </div>
            <span class="text-sm font-bold text-green-600">‡∏ø${data.totalRevenue.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</span>
          </div>
        </div>
      `).join('');

      document.getElementById('todayFuelSummary').innerHTML = summaryHtml;
    }

    function updateTodayRecords() {
      const today = new Date().toISOString().split('T')[0];
      const todayRecordsList = records.filter(r => r.date === today).sort((a, b) =>
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      const container = document.getElementById('todayRecords');
      if (todayRecordsList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
        return;
      }

      container.innerHTML = todayRecordsList.map(r => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 flex-1">
              <div class="w-10 h-10 ${r.shift === 'morning' ? 'bg-yellow-100' : 'bg-indigo-100'} rounded-lg flex items-center justify-center">
                <span>${r.shift === 'morning' ? '‚òÄÔ∏è' : 'üåô'}</span>
              </div>
              <div>
                <p class="font-medium text-gray-800">${r.nozzle_name}</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="fuel-badge ${r.fuel_type}">${fuelTypeNames[r.fuel_type]}</span>
                  <span class="text-xs text-gray-500">${r.shift === 'morning' ? settings.shift1Name : settings.shift2Name}</span>
                  <span class="text-xs text-gray-500">${r.liters_sold.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</span>
                </div>
              </div>
            </div>
            <div class="text-right flex items-center gap-2">
              <div>
                <p class="font-bold text-green-600">‡∏ø${r.revenue.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
                <p class="text-xs text-emerald-600">‡∏Å‡∏≥‡πÑ‡∏£ ‡∏ø${r.profit.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
              </div>
              <div class="flex flex-col gap-1">
                <button onclick="openEditModal('${r.__backendId}')" class="text-[10px] bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded transition-all">
                  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="deleteRecord('${r.__backendId}')" class="text-[10px] bg-red-100 text-red-600 hover:bg-red-200 px-2 py-1 rounded transition-all">
                  ‚ùå ‡∏•‡∏ö
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function deleteRecord(id) {
      deleteTarget = { type: 'record', id };
      document.getElementById('deleteModalText').textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function deleteStockRecord(id) {
      deleteTarget = { type: 'stock_record', id };
      document.getElementById('deleteModalText').textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    let editTargetId = null;
    function openEditModal(id) {
      const record = records.find(r => r.__backendId === id);
      if (!record) return;

      editTargetId = id;
      document.getElementById('editRecordNozzle').textContent = `‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢: ${record.nozzle_name} (${record.shift === 'morning' ? settings.shift1Name : settings.shift2Name})`;
      document.getElementById('editMeterStart').value = record.meter_start;
      document.getElementById('editMeterEnd').value = record.meter_end;
      document.getElementById('editRecordModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editRecordModal').classList.add('hidden');
      editTargetId = null;
    }

    async function confirmEditRecord() {
      if (!editTargetId) return;
      const record = records.find(r => r.__backendId === editTargetId);
      if (!record) return;

      const newMeterEnd = parseFloat(document.getElementById('editMeterEnd').value);
      if (isNaN(newMeterEnd) || newMeterEnd <= record.meter_start) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)', 'error');
        return;
      }

      const newLiters = newMeterEnd - record.meter_start;
      const newRevenue = newLiters * record.price_per_liter;
      const newCost = newLiters * record.cost_per_liter;
      const newProfit = newRevenue - newCost;

      const updatedRecord = {
        ...record,
        meter_end: newMeterEnd,
        liters_sold: newLiters,
        revenue: newRevenue,
        cost: newCost,
        profit: newProfit,
        timestamp: new Date().toISOString() // Update timestamp to show it was edited
      };

      showLoading(true);
      const result = await window.dataSdk.update(updatedRecord);
      showLoading(false);
      closeEditModal();

      if (result.isOk) {
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
      }
    }

    function deleteTank(id) {
      deleteTarget = { type: 'tank', id };
      document.getElementById('deleteModalText').textContent = '‡∏•‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function updateNozzleList() {
      const container = document.getElementById('nozzleList');
      if (nozzles.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</p>';
        return;
      }

      container.innerHTML = nozzles.map(n => `
        <div class="p-3 bg-gray-50 rounded-lg flex items-center justify-between">
          <div class="flex items-center gap-3 flex-1">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <span>üîå</span>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">${n.nozzle_name}</p>
              <div class="flex items-center gap-2 mt-1">
                <span class="fuel-badge ${n.fuel_type}">${fuelTypeNames[n.fuel_type]}</span>
                <span class="text-xs text-blue-600 font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏ø${(settings.fuelPrices[n.fuel_type] || 0).toFixed(2)}</span>
              </div>
            </div>
          </div>
          <button onclick="deleteNozzle('${n.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all">
            üóëÔ∏è
          </button>
        </div>
      `).join('');
    }

    function deleteNozzle(id) {
      deleteTarget = { type: 'nozzle', id };
      document.getElementById('deleteModalText').textContent = '‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
      deleteTarget = null;
    }

    async function confirmDelete() {
      if (!deleteTarget) return;

      const item = allData.find(d => d.__backendId === deleteTarget.id);
      if (!item) {
        closeDeleteModal();
        return;
      }

      showLoading(true);
      const result = await window.dataSdk.delete(item);
      showLoading(false);
      closeDeleteModal();

      if (result.isOk) {
        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    function handleReportTypeChange() {
      const type = document.getElementById('reportType').value;
      document.getElementById('filterDaily').classList.toggle('hidden', type !== 'daily');
      document.getElementById('filterRange').classList.toggle('hidden', type !== 'range');
      document.getElementById('filterMonthly').classList.toggle('hidden', type !== 'monthly');
    }

    function generateReport() {
      const type = document.getElementById('reportType').value;
      const shiftFilter = document.getElementById('reportShift').value;
      let filteredRecords = [];
      let periodText = '';

      if (type === 'daily') {
        const date = document.getElementById('reportDate').value;
        filteredRecords = records.filter(r => r.date === date && (!shiftFilter || r.shift === shiftFilter));
        periodText = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(date)}${shiftFilter ? ' (' + (shiftFilter === 'morning' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢') + ')' : ''}`;
      } else if (type === 'range') {
        const start = document.getElementById('reportStartDate').value;
        const end = document.getElementById('reportEndDate').value;
        filteredRecords = records.filter(r => r.date >= start && r.date <= end && (!shiftFilter || r.shift === shiftFilter));
        periodText = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(start)} - ${formatThaiDate(end)}${shiftFilter ? ' (' + (shiftFilter === 'morning' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢') + ')' : ''}`;
      } else {
        const month = document.getElementById('reportMonth').value;
        filteredRecords = records.filter(r => r.date.startsWith(month) && (!shiftFilter || r.shift === shiftFilter));
        periodText = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${formatThaiMonth(month)}${shiftFilter ? ' (' + (shiftFilter === 'morning' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢') + ')' : ''}`;
      }

      let totalSales = 0;
      let totalLiters = 0;
      let totalCost = 0;

      filteredRecords.forEach(r => {
        totalSales += r.revenue || 0;
        totalLiters += r.liters_sold || 0;
        totalCost += r.cost || 0;
      });

      const profit = totalSales - totalCost;

      const fuelUsage = {};
      filteredRecords.forEach(r => {
        if (!fuelUsage[r.fuel_type]) {
          fuelUsage[r.fuel_type] = { liters: 0, sales: 0, cost: 0 };
        }
        fuelUsage[r.fuel_type].liters += r.liters_sold;
        fuelUsage[r.fuel_type].sales += r.revenue;
        fuelUsage[r.fuel_type].cost += r.cost;
      });

      reportData = {
        type,
        periodText,
        records: filteredRecords,
        totalSales,
        totalLiters,
        totalCost,
        profit,
        fuelUsage
      };

      document.getElementById('reportSummary').classList.remove('hidden');
      document.getElementById('reportPeriod').textContent = periodText;
      document.getElementById('reportTotalSales').textContent = '‡∏ø' + totalSales.toLocaleString('th-TH', { minimumFractionDigits: 0 });
      document.getElementById('reportTotalLiters').textContent = totalLiters.toFixed(0) + ' ‡∏•‡∏¥‡∏ï‡∏£';
      document.getElementById('reportTotalCost').textContent = '‡∏ø' + totalCost.toLocaleString('th-TH', { minimumFractionDigits: 0 });
      document.getElementById('reportTotalProfit').textContent = '‡∏ø' + profit.toLocaleString('th-TH', { minimumFractionDigits: 0 });

      const fuelSummaryHtml = Object.entries(fuelUsage).map(([fuelType, data]) => `
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fuel-badge ${fuelType}">${fuelTypeNames[fuelType]}</span>
              <span class="text-sm font-bold text-gray-800">${data.liters.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</span>
            </div>
            <span class="text-sm font-bold text-green-600">‡∏ø${data.sales.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</span>
          </div>
        </div>
      `).join('');
      document.getElementById('fuelTypeSummary').innerHTML = fuelSummaryHtml;

      const byNozzle = {};
      filteredRecords.forEach(r => {
        const key = r.nozzle_name;
        if (!byNozzle[key]) {
          byNozzle[key] = { sales: 0, liters: 0, cost: 0, fuelType: r.fuel_type };
        }
        byNozzle[key].sales += r.revenue;
        byNozzle[key].liters += r.liters_sold;
        byNozzle[key].cost += r.cost;
      });

      const detailsHtml = Object.entries(byNozzle).map(([name, data]) => `
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="font-medium">${name}</span>
              <span class="fuel-badge ${data.fuelType}">${fuelTypeNames[data.fuelType]}</span>
            </div>
          </div>
          <div class="grid grid-cols-4 gap-2 text-center text-sm">
            <div>
              <p class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</p>
              <p class="font-bold text-blue-600">‡∏ø${data.sales.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
            </div>
            <div>
              <p class="text-gray-500">‡∏•‡∏¥‡∏ï‡∏£</p>
              <p class="font-bold text-green-600">${data.liters.toFixed(0)}</p>
            </div>
            <div>
              <p class="text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</p>
              <p class="font-bold text-amber-600">‡∏ø${data.cost.toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
            </div>
            <div>
              <p class="text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£</p>
              <p class="font-bold text-emerald-600">‡∏ø${(data.sales - data.cost).toLocaleString('th-TH', { minimumFractionDigits: 0 })}</p>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('reportNozzleDetails').innerHTML = detailsHtml || '<p class="text-gray-400 text-sm text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    }

    async function exportPDF() {
      if (!reportData) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      showLoading(true);

      // Create a temporary container for the PDF content
      const element = document.createElement('div');
      element.style.padding = '40px';
      element.style.background = 'white';
      element.style.color = '#333';
      element.style.fontFamily = "'Sarabun', sans-serif";

      // Calculate summaries
      const byNozzle = {};
      reportData.records.forEach(r => {
        const key = r.nozzle_name;
        if (!byNozzle[key]) {
          byNozzle[key] = { sales: 0, liters: 0, cost: 0, fuelType: r.fuel_type };
        }
        byNozzle[key].sales += r.revenue;
        byNozzle[key].liters += r.liters_sold;
        byNozzle[key].cost += r.cost;
      });

      const fuelSummaryHtml = Object.entries(reportData.fuelUsage).map(([fuelType, data]) => `
        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
          <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 4px;">${fuelTypeNames[fuelType]}</div>
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢:</span>
            <span style="font-weight: bold;">${data.liters.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</span>
            <span style="font-weight: bold; color: #16a34a;">‡∏ø${data.sales.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</span>
          </div>
        </div>
      `).join('');

      const nozzleTableRows = Object.entries(byNozzle).map(([name, data]) => `
        <tr style="border-bottom: 1px solid #e2e8f0;">
          <td style="padding: 10px; font-weight: bold;">${name}</td>
          <td style="padding: 10px;">${fuelTypeNames[data.fuelType]}</td>
          <td style="padding: 10px; text-align: right;">${data.liters.toFixed(2)}</td>
          <td style="padding: 10px; text-align: right;">‡∏ø${data.sales.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
          <td style="padding: 10px; text-align: right;">‡∏ø${data.cost.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
          <td style="padding: 10px; text-align: right; color: #16a34a; font-weight: bold;">‡∏ø${(data.sales - data.cost).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
        </tr>
      `).join('');

      element.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e3a8a; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3a8a; font-size: 28px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h1>
          <p style="margin: 10px 0 0; color: #64748b; font-size: 16px;">${reportData.periodText}</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; text-align: center;">
            <div style="font-size: 12px; color: #1e40af;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div style="font-size: 20px; font-weight: bold; color: #1d4ed8;">‡∏ø${reportData.totalSales.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
          </div>
          <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; text-align: center;">
            <div style="font-size: 12px; color: #166534;">‡∏•‡∏¥‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div style="font-size: 20px; font-weight: bold; color: #15803d;">${reportData.totalLiters.toFixed(2)} ‡∏•‡∏¥‡∏ï‡∏£</div>
          </div>
          <div style="background: #fffbeb; padding: 15px; border-radius: 12px; border: 1px solid #fef3c7; text-align: center;">
            <div style="font-size: 12px; color: #92400e;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
            <div style="font-size: 20px; font-weight: bold; color: #b45309;">‡∏ø${reportData.totalCost.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
          </div>
          <div style="background: #ecfdf5; padding: 15px; border-radius: 12px; border: 1px solid #d1fae5; text-align: center;">
            <div style="font-size: 12px; color: #065f46;">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
            <div style="font-size: 20px; font-weight: bold; color: #047857;">‡∏ø${reportData.profit.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h2 style="font-size: 18px; color: #1e3a8a; border-left: 4px solid #1e3a8a; padding-left: 10px; margin-bottom: 15px;">üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h2>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            ${fuelSummaryHtml}
          </div>
        </div>

        <div>
          <h2 style="font-size: 18px; color: #1e3a8a; border-left: 4px solid #1e3a8a; padding-left: 10px; margin-bottom: 15px;">üîå ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</h2>
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #1e3a8a; color: white;">
                <th style="padding: 12px; text-align: left; border-top-left-radius: 8px;">‡∏´‡∏±‡∏ß‡∏à‡πà‡∏≤‡∏¢</th>
                <th style="padding: 12px; text-align: left;">‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</th>
                <th style="padding: 12px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏¥‡∏ï‡∏£</th>
                <th style="padding: 12px; text-align: right;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                <th style="padding: 12px; text-align: right;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                <th style="padding: 12px; text-align: right; border-top-right-radius: 8px;">‡∏Å‡∏≥‡πÑ‡∏£</th>
              </tr>
            </thead>
            <tbody>
              ${nozzleTableRows}
            </tbody>
          </table>
        </div>

        <div style="margin-top: 40px; text-align: right; color: #94a3b8; font-size: 12px;">
          ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}
        </div>
      `;

      const opt = {
        margin: 10,
        filename: `gas-station-report-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(opt).from(element).save();
        showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
      } catch (error) {
        console.error('PDF export error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF', 'error');
      } finally {
        showLoading(false);
      }
    }

    function formatThaiDate(dateStr) {
      if (!dateStr) return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
      const date = new Date(dateStr + 'T00:00:00');
      const options = { day: 'numeric', month: 'short', year: 'numeric' };
      return date.toLocaleDateString('th-TH', options);
    }

    function formatThaiMonth(monthStr) {
      const [year, month] = monthStr.split('-');
      const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      return `${monthNames[parseInt(month) - 1]} ${parseInt(year) + 543}`;
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all';
      toast.classList.add(type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-gray-800', 'text-white');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }

    init();
  </script>
  <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9cec2c506345d33a',t:'MTc3MTIzNTc2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>